FROM golang:1.17.5-alpine AS build

WORKDIR /src/
COPY . /src/

RUN apk update && apk add git curl
RUN go mod download
RUN CGO_ENABLED=0 go build -o /bin/vulnerability-exporter
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /bin v0.22.0

FROM alpine:3.15.0
COPY --from=build /bin/vulnerability-exporter /bin/vulnerability-exporter
COPY --from=build /bin/trivy /usr/local/bin/trivy
ENTRYPOINT ["/bin/vulnerability-exporter"]