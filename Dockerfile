FROM golang:1.17.5-alpine AS build

WORKDIR /src/

RUN apk add --update --no-cache curl git
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /bin v0.22.0

COPY go.mod .
COPY go.sum .
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /bin/vulnerability-exporter

FROM alpine:3.15.0
COPY --from=build /bin/vulnerability-exporter /bin/vulnerability-exporter
COPY --from=build /bin/trivy /usr/local/bin/trivy
ENTRYPOINT ["/bin/vulnerability-exporter"]